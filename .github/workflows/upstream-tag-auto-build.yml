name: 跟踪上游 tag 自动构建镜像

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

concurrency:
  group: upstream-tag-auto-build
  cancel-in-progress: true

permissions:
  contents: write
  packages: write

env:
  IMAGE_NAME: openclaw
  UPSTREAM_REPO: openclaw/openclaw
  MARKER_TAG_PREFIX: upstream-

jobs:
  detect:
    name: 检测上游最新 tag
    runs-on: ubuntu-latest
    outputs:
      upstream_tag: ${{ steps.detect.outputs.upstream_tag }}
      marker_tag: ${{ steps.detect.outputs.marker_tag }}
      should_build: ${{ steps.detect.outputs.should_build }}
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 检测是否有新 tag
        id: detect
        run: |
          set -euo pipefail

          git fetch --tags --force

          upstream_tag="$(git ls-remote --tags --refs "https://github.com/${UPSTREAM_REPO}.git" "v*" | awk -F/ '{print $3}' | sort -V | tail -n1)"

          if [ -z "${upstream_tag}" ]; then
            echo "未获取到上游 tag，终止本次流程。" >&2
            exit 1
          fi

          marker_tag="${MARKER_TAG_PREFIX}${upstream_tag}"
          should_build="true"

          if git rev-parse -q --verify "refs/tags/${marker_tag}" >/dev/null; then
            should_build="false"
          fi

          echo "upstream_tag=${upstream_tag}" >> "$GITHUB_OUTPUT"
          echo "marker_tag=${marker_tag}" >> "$GITHUB_OUTPUT"
          echo "should_build=${should_build}" >> "$GITHUB_OUTPUT"

          echo "最新上游 tag: ${upstream_tag}"
          echo "标记 tag: ${marker_tag}"
          echo "是否构建: ${should_build}"

  build-and-push:
    name: 构建并发布镜像
    needs: detect
    if: needs.detect.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 配置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 构建镜像（本地加载）
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: false
          load: true
          tags: local/${{ env.IMAGE_NAME }}:amd64-test
          build-args: |
            OPENCLAW_VERSION=${{ needs.detect.outputs.upstream_tag }}

      - name: 运行基础功能测试
        run: |
          docker run --rm \
            -e OPENCLAW_AUTO_CONFIG=false \
            local/${{ env.IMAGE_NAME }}:amd64-test \
            sh -lc "node --version && npm --version && python3 --version && pip3 --version && git --version && aws --version && openclaw --version"

      - name: 运行端口校验测试
        run: |
          if docker run --rm \
            -e OPENCLAW_AUTO_CONFIG=false \
            -e OPENCLAW_PORT=70000 \
            local/${{ env.IMAGE_NAME }}:amd64-test true; then
            echo "端口校验测试失败：OPENCLAW_PORT=70000 应该报错" >&2
            exit 1
          fi

      - name: 登录 Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 登录 GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 推送镜像（上游版本标签 + latest）
        env:
          UPSTREAM_TAG: ${{ needs.detect.outputs.upstream_tag }}
        run: |
          set -euo pipefail

          dockerhub_tag="docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${UPSTREAM_TAG}"
          ghcr_tag="ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${UPSTREAM_TAG}"

          dockerhub_latest="docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          ghcr_latest="ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest"

          docker tag local/${{ env.IMAGE_NAME }}:amd64-test "${dockerhub_tag}"
          docker tag local/${{ env.IMAGE_NAME }}:amd64-test "${ghcr_tag}"
          docker tag local/${{ env.IMAGE_NAME }}:amd64-test "${dockerhub_latest}"
          docker tag local/${{ env.IMAGE_NAME }}:amd64-test "${ghcr_latest}"

          docker push "${dockerhub_tag}"
          docker push "${ghcr_tag}"
          docker push "${dockerhub_latest}"
          docker push "${ghcr_latest}"

      - name: 写入已处理 marker tag
        env:
          MARKER_TAG: ${{ needs.detect.outputs.marker_tag }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "${MARKER_TAG}"
          git push origin "refs/tags/${MARKER_TAG}"

